---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r knitr-options, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-",
  message = FALSE,
  warning = TRUE
)
```

# quasardb

:warning:**WARNING**: Early stage development version. Use at your own risk.

:information_source:**NOTE**: Only :apple:macOS and Windows are currently supported.

The quasardb package is the official R API for [quasardb](https://www.quasardb.net) timeseries database.

## Installation

<!-- TODO:
You can install the released version from CRAN with:
```{r installation, eval = FALSE}
install.packages("quasardb")
```
-->

You can install quasardb from [GitHub](https://github.com/bureau14/qdb-api-r) with:

```{r gh-installation, eval = FALSE}
# install.packages("devtools")
devtools::install_github("bureau14/qdb-api-r")
```

### quasardb C API

To build the R API, you will need the C API.
It can either be installed on the machine system-wide
(e.g. on UNIX in `/usr/lib` or `/usr/local/lib`)
or you can unpack the C API archive in `inst` directory.
On Windows, you need to verify additionally that the `qdb_api.dll` is in the
`PATH` environment variable.

You can get the C API as well as other tools from [our download page](https://www.quasardb.net/-Get-).

### Building the extension from source

To perform a clean build:
```{r build-extension, eval = FALSE}
devtools::build(binary = TRUE)
```

To update documentation and auto-generated files:
```{r document-extension, eval = FALSE}
devtools::document()
```

Only update the documentation in man, but don't regenerate R files:
```{r roxygenize-extension, eval = FALSE}
roxygen2::roxygenize()
```

To check the extension:
```{r check-extension, eval = FALSE}
devtools::check(check_version = TRUE)
```

You may wish to skip tests using:
```{r check-extension-without-tests, eval = FALSE}
devtools::check(check_version = TRUE, args = "--no-tests")
```

To test the extension:
```{r test-extension, eval = FALSE}
devtools::test()
```

## Usage

<!-- TODO:
To regenerate the readme with knitr, run `qdbd --transient --security=false`.
Let automatise this!
-->

Load library:
```{r load-quasardb-extension}
library(quasardb)
```

Get underlying C API version:

```{r example-version}
version()
```

Get underlying C API build id and date:
```{r example-build,}
build()
```

Connect to a quasardb cluster at a default URI `qdb://127.0.0.1:2836`:
```{r example-connect-default}
handle <- connect()
```

Connect to a quasardb cluster at a user-provided URI:
```{r example-connect}
handle <- connect("qdb://127.0.0.1:2836")
```

```{r example-entry_remove-if-exists, include = FALSE}
# Remove the example entry, but ignore any error.
handle <- connect("qdb://127.0.0.1:2836")

skip_alias_not_found <- function (e) {
  if (!grepl(pattern = "b1000008", x = e, fixed = TRUE)) {
    stop("Unexpected error: ", e)
  }
}

tryCatch(
  entry_remove(handle, name = "timeseries1"),
  error = skip_alias_not_found,
  warning = skip_alias_not_found
)
tryCatch(
  entry_remove(handle, name = "timeseries2"),
  error = skip_alias_not_found,
  warning = skip_alias_not_found
)
```

Create a timeseries:
```{r example-ts_create}
handle <- connect("qdb://127.0.0.1:2836")
ts_create(handle, name = "timeseries1",
     columns = c("column1" = column_type$blob, "column2" = column_type$double))
```

```{r example-ts_create2, include = FALSE}
handle <- connect("qdb://127.0.0.1:2836")
ts_create(handle, name = "timeseries2",
     columns = c("column1" = column_type$blob, "column2" = column_type$double))
```

Show information about the columns of a timeseries:
```{r example-ts_show}
handle <- connect("qdb://127.0.0.1:2836")
columns <- ts_show(handle, name = "timeseries1")
columns
sapply(columns, function(ct) {
  names(which(ct == column_type))
})
```

Add a tag to an entry:
```{r example-attach_tags-single}
handle <- connect("qdb://127.0.0.1:2836")
attach_tags(handle, entry = "timeseries1", tags = "my_tag")
```

```{r example-attach_tags-single2, include = FALSE}
handle <- connect("qdb://127.0.0.1:2836")
attach_tags(handle, entry = "timeseries2", tags = "my_tag")
```

Add many tags at once:
```{r example-attach_tags-many}
handle <- connect("qdb://127.0.0.1:2836")
attach_tags(handle,
                entry = "timeseries1",
                tags = c("my_tag1", "my_tag2", "my_tag3"))
```

Get tags of an entry:
```{r example-get_tags}
handle <- connect("qdb://127.0.0.1:2836")
tags <- get_tags(handle, name = "timeseries1")
tags
```

Get all entries marked with a tag:
```{r example-get_tagged}
handle <- connect("qdb://127.0.0.1:2836")
entries <- get_tagged(handle, tag = "my_tag")
entries
```


Get all entry keys matching given find query:
```{r example-query_find}
handle <- connect("qdb://127.0.0.1:2836")
# Get all entries (precisely: their keys) tagged with 'my-tag' being timeseries.
keys <- query_find(handle, "find(tag='my_tag' and type=ts)")
keys
```

Untag an entry:
```{r example-detach_tags}
handle <- connect("qdb://127.0.0.1:2836")
detach_tags(handle, entry = "timeseries2", tag = "my_tag")
# Now, timeseries2 is no more on the list.
keys <- query_find(handle, "find(tag='my_tag' and type=ts)")
keys
```

Execute a select query:
```{r example-query}
handle <- connect("qdb://127.0.0.1:2836")
# Get number of elements in each column of the timeseries in year 2017.
result <-
  query(handle, "select count(*) from timeseries1 in range(2017, +1y)")
result$scanned_rows_count
result$tables[["timeseries1"]]$data
```

Remove an entry:
```{r example-entry_remove}
handle <- connect("qdb://127.0.0.1:2836")
entry_remove(handle, name = "timeseries1")
```

## TODO

 - Add `ts_insert` (only stub is currently implemented), `has_tag`.
 - Make compliant with other OSes: Linux, FreeBSD.
 - Make a quasardb driver compliant with [DBI package](https://www.rdocumentation.org/packages/DBI/).
